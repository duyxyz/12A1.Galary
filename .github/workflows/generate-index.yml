name: Auto Generate Image Index

on:
  push:
    paths:
      - '*.webp'
  workflow_dispatch:

jobs:
  generate-index:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: pip install Pillow

      - name: Generate Image Index
        run: |
          python3 << 'PYTHON_SCRIPT'
          import os
          import json
          from pathlib import Path
          from PIL import Image
          from datetime import datetime

          def get_sort_key(filename):
              """Sáº¯p xáº¿p: sá»‘ lá»›n -> nhá», sau Ä‘Ã³ chuá»—i A-Z"""
              base = filename.split('.')[0]
              if base.isdigit():
                  return (0, -int(base))  # NhÃ³m sá»‘, sáº¯p xáº¿p giáº£m dáº§n
              else:
                  return (1, base.lower())  # NhÃ³m chuá»—i, sáº¯p xáº¿p tÄƒng dáº§n

          def get_image_info(filepath):
              """Láº¥y thÃ´ng tin áº£nh"""
              try:
                  with Image.open(filepath) as img:
                      return {
                          'width': img.width,
                          'height': img.height,
                          'format': img.format,
                          'mode': img.mode
                      }
              except Exception as e:
                  print(f'âš ï¸  Lá»—i Ä‘á»c file {filepath}: {e}')
                  return None

          def main():
              # QuÃ©t táº¥t cáº£ file .webp trong thÆ° má»¥c gá»‘c
              root_path = Path('.')
              webp_files = sorted(
                  root_path.glob('*.webp'),
                  key=lambda p: get_sort_key(p.name)
              )

              if not webp_files:
                  print('â„¹ï¸  KhÃ´ng tÃ¬m tháº¥y file .webp nÃ o')
                  return

              results = []
              success_count = 0
              error_count = 0

              print(f'ðŸ” Äang quÃ©t {len(webp_files)} file...\n')

              for file_path in webp_files:
                  filename = file_path.name
                  base_name = file_path.stem
                  
                  info = get_image_info(file_path)
                  if info:
                      results.append({
                          'i': int(base_name) if base_name.isdigit() else base_name,
                          'w': info['width'],
                          'h': info['height'],
                          'f': info['format'],
                          'm': info['mode']
                      })
                      success_count += 1
                      print(f'âœ… {filename}: {info["width"]}x{info["height"]}')
                  else:
                      error_count += 1

              # LÆ°u káº¿t quáº£
              output_data = {
                  'generated_at': datetime.utcnow().isoformat() + 'Z',
                  'total_images': len(results),
                  'images': results
              }

              output_file = Path('images.json')
              with open(output_file, 'w', encoding='utf-8') as f:
                  json.dump(output_data, f, ensure_ascii=False, indent=2)

              print(f'\nðŸ“Š Tá»•ng káº¿t:')
              print(f'   â€¢ ThÃ nh cÃ´ng: {success_count}')
              print(f'   â€¢ Lá»—i: {error_count}')
              print(f'   â€¢ ÄÃ£ lÆ°u vÃ o: {output_file}')

          if __name__ == '__main__':
              main()
          PYTHON_SCRIPT

      - name: Check for Changes
        id: check_changes
        run: |
          if git diff --quiet images.json; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  KhÃ´ng cÃ³ thay Ä‘á»•i trong images.json"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ¨ PhÃ¡t hiá»‡n thay Ä‘á»•i trong images.json"
          fi

      - name: Commit and Push
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          
          git add images.json
          git commit -m "ðŸ¤– Auto-update images.json [skip ci]" -m "Updated by GitHub Actions workflow"
          
          # Thá»­ push, náº¿u tháº¥t báº¡i thÃ¬ pull vÃ  push láº¡i
          max_retries=3
          retry_count=0
          
          while [ $retry_count -lt $max_retries ]; do
            if git push; then
              echo "âœ… Push thÃ nh cÃ´ng!"
              exit 0
            else
              echo "âš ï¸  Push tháº¥t báº¡i, Ä‘ang thá»­ pull vÃ  push láº¡i... (láº§n $((retry_count + 1)))"
              git pull --rebase origin ${{ github.ref_name }}
              retry_count=$((retry_count + 1))
              sleep 2
            fi
          done
          
          echo "âŒ KhÃ´ng thá»ƒ push sau $max_retries láº§n thá»­"
          exit 1

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“¸ Image Index Generation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f images.json ]; then
            total=$(jq '.total_images' images.json)
            echo "âœ… **HoÃ n thÃ nh**: ÄÃ£ index $total áº£nh" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“„ Xem chi tiáº¿t táº¡i: \`images.json\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Lá»—i**: KhÃ´ng táº¡o Ä‘Æ°á»£c images.json" >> $GITHUB_STEP_SUMMARY
          fi
